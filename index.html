<html>

<body>
  <p id='motion'></p>
  <p id='motion2'></p>
  <canvas id="myChart" width="900" height="200"></canvas>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/85/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
  <script>
    var socket = io();

    var geometry = new THREE.BoxGeometry(700, 700, 700, 3, 3, 3);
    var material = new THREE.MeshBasicMaterial({
      color: 0xfffff,
      wireframe: true
    });

    var scene1 = three();
    var cube1 = new THREE.Mesh(geometry, material);
    scene1.add(cube1);

    var scene2 = three();
    var cube2 = new THREE.Mesh(geometry, material);
    scene2.add(cube2);

    var el = document.getElementById('motion');
    socket.on('motion', function (motion) {
      handleMotionEvent(cube1, motion);
      el.innerHTML = JSON.stringify(motion, null, 2).split('\n').join('<br/>');
    });
    var el2 = document.getElementById('motion2');
    socket.on('motion2', function (motion) {
      handleMotionEvent2(cube2, motion);
      el2.innerHTML = JSON.stringify(motion, null, 2).split('\n').join('<br/>');
    });

    function handleMotionEvent(cube, event) {
      var x = event.accX;
      var y = event.accY;
      var z = event.accZ;

      cube.rotation.x = Math.atan2(y, z);
      cube.rotation.z = Math.atan2(x, Math.sqrt(y * y + z * z));
      cube.rotation.y = 0;
    };

    function handleMotionEvent2(cube, { roll, pitch, yaw }) {
      var time = moment().toDate();
      chartPitch.push({ x: time, y: -pitch });
      chartRoll.push({ x: time, y: roll });
      chartYaw.push({ x: time, y: -yaw });

      if (chartPitch.length >= 100) {
        chartPitch.shift();
      }

      if (chartRoll.length >= 100) {
        chartRoll.shift();
      }

      if (chartYaw.length >= 100) {
        chartYaw.shift();
      }

      myChart.update();
      cube.rotation.x = roll * Math.PI / 180;
      cube.rotation.z = -pitch * Math.PI / 180;
      cube.rotation.y = -yaw * Math.PI / 180;
    };

    function three() {
      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera(75, 320 / 240, 1, 10000);
      camera.position.z = 1000;

      var renderer = new THREE.WebGLRenderer({
        antialias: true
      });
      renderer.setSize(320, 240);
      document.body.appendChild(renderer.domElement);

      function render() {
        requestAnimationFrame(render);
        renderer.render(scene, camera);
      }

      render();

      return scene;
    }




    /////////////////////////////

var chartPitch = [];
var chartRoll = [];
var chartYaw = [];

var chartData = {
    datasets: [{
        label: 'pitch',
        data: chartPitch,
        backgroundColor: 'rgba(255, 99, 132, 0.01)',
        borderColor: 'rgba(255,99,132,1)',
        borderWidth: 1
    }, {
        label: 'roll',
        data: chartRoll,
        backgroundColor: 'rgba(255, 99, 132, 0.01)',
        borderColor: 'rgba(255,99,132,1)',
        borderWidth: 1
    }, {
        label: 'yaw',
        data: chartYaw,
        backgroundColor: 'rgba(255, 99, 132, 0.01)',
        borderColor: 'rgba(255,99,132,1)',
        borderWidth: 1
    }]
};
var ctx = document.getElementById("myChart").getContext('2d');
var myChart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
        responsive: false,
        scales: {
            xAxes: [{
                type: 'time',
                display: false,
                scaleLabel: {
                  display: false,
                  labelString: 'Date'
                }
            }],
            yAxes: [{
                ticks: {
                    beginAtZero:true
                }
            }]
          },
          animation: {
            duration: 0
          }
    }
});

  </script>
</body>

</html>
