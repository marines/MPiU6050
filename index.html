<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>MPiU6050 wireless IMU</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
  <style>
    body {
      padding-top: 50px;
    }

    .angle {
      text-align: right;
    }

    .angle span {
      display: inline-block;
      width: 35px;
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false"
          aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
        <a class="navbar-brand" href="#">MPiU6050</a>
      </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li class="angle"><a href="#">X: <span id="angleX"></span></a></li>
          <li class="angle"><a href="#">Y: <span id="angleY"></span></a></li>
          <li class="angle"><a href="#">Z: <span id="angleZ"></span></a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
            <li style="padding-top:0.5em"><button id="resetBtn" class="btn btn-primary">Reset</button></li>
          </ul>
      </div>
      <!--/.nav-collapse -->
    </div>
  </nav>

  <div class="container">
    <div id="scene" class="col-md-8"></div>
    <div class="col-md-4">
      <canvas id="myChart" width="200" height="300"></canvas>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/85/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
  <script>
    var socket = io();

    function round(n) {
      var rounded = Math.round(n*10)/10;
      if (rounded === Math.round(n)) {
        return `${rounded}.0`;
      }
      return rounded;
    }

    var angleXEl = document.getElementById('angleX');
    var angleYEl = document.getElementById('angleY');
    var angleZEl = document.getElementById('angleZ');
    var sceneEl = document.getElementById('scene');
    var resetEl = document.getElementById('resetBtn');

    var sceneWidth = sceneEl.clientWidth;
    var sceneHeight = 480;

    resetEl.onclick = function (e) {
      e.preventDefault();
      console.log('resetting');
      socket.emit('reset', true);
    }

    var geometry = new THREE.BoxGeometry(700, 100, 300, 3, 3, 3);
    var material = new THREE.MeshBasicMaterial({
      color: 0x000000,
      wireframe: true
    });
    var scene = new THREE.Scene();
    var camera = new THREE.PerspectiveCamera(75, sceneWidth / sceneHeight, 1, 10000);
    camera.position.z = 1000;
    var renderer = new THREE.WebGLRenderer({
      alpha: true,
      antialias: true
    });
    renderer.setSize(sceneWidth, sceneHeight);
    renderer.setClearColor(0xffffff, 0);
    var cube = new THREE.Mesh(geometry, material);
    scene.add(cube);

    document.getElementById('scene').appendChild(renderer.domElement);


    socket.on('motion', function (motion) {
      handleMotionEvent2(cube, motion);
      angleXEl.innerText = round(motion[0]);
      angleYEl.innerText = round(motion[1]);
      angleZEl.innerText = round(motion[2]);
    });

    function handleMotionEvent2(cube, [roll, pitch, yaw]) {
      var time = moment().toDate();

      chartLabels.push(time);
      chartPitch.push({
        x: time,
        y: pitch
      });
      chartRoll.push({
        x: time,
        y: roll
      });
      chartYaw.push({
        x: time,
        y: yaw
      });

      if (chartLabels.length >= 25) {
        chartLabels.shift();
      }

      if (chartPitch.length >= 25) {
        chartPitch.shift();
      }

      if (chartRoll.length >= 25) {
        chartRoll.shift();
      }

      if (chartYaw.length >= 25) {
        chartYaw.shift();
      }

      cube.rotation.z = roll * Math.PI / 180;
      cube.rotation.x = pitch * Math.PI / 180;
      cube.rotation.y = yaw * Math.PI / 180;
    };

    /////////////////////////////

    var chartPitch = [];
    var chartRoll = [];
    var chartYaw = [];
    var chartLabels = [];


    var chartData = {
      labels: chartLabels,
      datasets: [{
        label: 'Y',
        data: chartPitch,
        fill: false,
        backgroundColor: 'rgba(205,92,92,1)',
        borderColor: 'rgba(205,92,92,1)',
        borderWidth: 2,
        pointRadius: 0,
        yAxisID: 'xyScale'
      }, {
        label: 'X',
        data: chartRoll,
        fill: false,
        backgroundColor: 'rgba(154,205,50,1)',
        borderColor: 'rgba(154,205,50,1)',
        borderWidth: 2,
        pointRadius: 0,
        yAxisID: 'xyScale'
      }, {
        label: 'Z',
        data: chartYaw,
        fill: false,
        backgroundColor: 'rgba(30,144,255,1)',
        borderColor: 'rgba(30,144,255,1)',
        borderWidth: 2,
        pointRadius: 0,
        yAxisID: 'zScale'
      }]
    };
    var ctx = document.getElementById("myChart").getContext('2d');
    var myChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        responsive: true,
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
          },
        },
        events: [],
        scales: {
          xAxes: [{
            type: 'time',
            display: false,
            scaleLabel: {
              display: false,
              labelString: 'Date'
            },
            time: {},
          }],
          yAxes: [{
            position: 'left',
            id: 'xyScale',
            ticks: {
              min: -90,
              max: 90,
              beginAtZero: true,
              stepSize: 30,
            }
          }, {
            position: 'right',
            id: 'zScale',
            ticks: {
              min: -360,
              max: 360,
              beginAtZero: true,
              stepSize: 120,
            },
            gridLines: {
              display: false,
            },
          }]
        },
        animation: false
      }
    });

    function render() {
      requestAnimationFrame(render);
      renderer.render(scene, camera);
      myChart.update();
    }

    render();
  </script>
</body>

</html>
